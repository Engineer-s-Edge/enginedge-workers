openapi: 3.0.3
info:
  title: LaTeX Worker API
  description: |
    Professional LaTeX compilation service with advanced features for document processing.
    
    **Features:**
    - XeLaTeX/LuaLaTeX compilation with Unicode support
    - Multi-file project support (\include, \input)
    - Bibliography and citation management (9 citation styles)
    - Custom font support with font validation
    - Math expression rendering (KaTeX integration)
    - Comprehensive error recovery and suggestions
    - Package auto-detection and installation
    - Async Kafka-based compilation queue
    - PDF generation with metadata preservation
    - Detailed compilation logs and performance metrics
  version: 1.0.0
  contact:
    name: API Support
    email: support@enginedge.com
  license:
    name: Proprietary

servers:
  - url: http://localhost:3003
    description: Development server
  - url: https://latex.enginedge.com
    description: Production server

tags:
  - name: Health
    description: Service health and status
  - name: Compilation
    description: Document compilation operations
  - name: Projects
    description: Project management
  - name: Templates
    description: Template management
  - name: Jobs
    description: Compilation job tracking

paths:
  /health:
    get:
      summary: Health check
      tags:
        - Health
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [ok, degraded]
                  timestamp:
                    type: string
                    format: date-time
                  uptime:
                    type: number
                    description: Uptime in seconds
                  services:
                    type: object
                    properties:
                      xelatex:
                        type: boolean
                      kafka:
                        type: boolean
                      mongodb:
                        type: boolean

  /latex/compile:
    post:
      summary: Compile LaTeX document (synchronous)
      tags:
        - Compilation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CompileCommand'
            example:
              jobId: compile-001
              userId: user-123
              content: |
                \documentclass{article}
                \usepackage{amsmath}
                \begin{document}
                \section{Introduction}
                This is a simple LaTeX document with $E=mc^2$.
                \end{document}
      responses:
        '200':
          description: Compilation successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CompilationResult'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Compilation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /latex/compile-async:
    post:
      summary: Queue LaTeX compilation (asynchronous via Kafka)
      tags:
        - Compilation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CompileCommand'
      responses:
        '202':
          description: Compilation queued
          content:
            application/json:
              schema:
                type: object
                properties:
                  jobId:
                    type: string
                  status:
                    type: string
                    enum: [pending, queued]
                  estimatedTime:
                    type: number
                    description: Estimated time in seconds

  /latex/jobs/{jobId}:
    get:
      summary: Get compilation job status
      tags:
        - Jobs
      parameters:
        - name: jobId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Job status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CompilationJob'
        '404':
          description: Job not found

  /latex/jobs/{jobId}/pdf:
    get:
      summary: Download compiled PDF
      tags:
        - Jobs
      parameters:
        - name: jobId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: PDF file
          content:
            application/pdf:
              schema:
                type: string
                format: binary
        '404':
          description: PDF not found
        '503':
          description: PDF not ready yet

  /latex/jobs/{jobId}/logs:
    get:
      summary: Get compilation logs
      tags:
        - Jobs
      parameters:
        - name: jobId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Compilation logs
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CompilationLogs'

  /latex/validate:
    post:
      summary: Validate LaTeX syntax without compilation
      tags:
        - Compilation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                content:
                  type: string
                  description: LaTeX document content
      responses:
        '200':
          description: Validation results
          content:
            application/json:
              schema:
                type: object
                properties:
                  valid:
                    type: boolean
                  errors:
                    type: array
                    items:
                      $ref: '#/components/schemas/CompilationError'
                  warnings:
                    type: array
                    items:
                      type: string

  /latex/projects:
    get:
      summary: List user projects
      tags:
        - Projects
      parameters:
        - name: userId
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: List of projects
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/LaTeXProject'

    post:
      summary: Create new project
      tags:
        - Projects
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                userId:
                  type: string
                name:
                  type: string
                mainFile:
                  type: string
                files:
                  type: array
                  items:
                    type: object
                    properties:
                      filename:
                        type: string
                      content:
                        type: string
      responses:
        '201':
          description: Project created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LaTeXProject'

  /latex/projects/{projectId}:
    get:
      summary: Get project details
      tags:
        - Projects
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Project details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LaTeXProject'

    put:
      summary: Update project
      tags:
        - Projects
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                mainFile:
                  type: string
      responses:
        '200':
          description: Project updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LaTeXProject'

    delete:
      summary: Delete project
      tags:
        - Projects
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Project deleted

  /latex/projects/{projectId}/files/{fileName}:
    put:
      summary: Update project file
      tags:
        - Projects
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
        - name: fileName
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                content:
                  type: string
      responses:
        '200':
          description: File updated

    delete:
      summary: Delete project file
      tags:
        - Projects
      parameters:
        - name: projectId
          in: path
          required: true
          schema:
            type: string
        - name: fileName
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: File deleted

  /latex/templates:
    get:
      summary: List templates
      tags:
        - Templates
      parameters:
        - name: category
          in: query
          schema:
            type: string
            enum: [resume, academic, business, article, book, presentation]
        - name: isPublic
          in: query
          schema:
            type: boolean
      responses:
        '200':
          description: List of templates
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/LaTeXTemplate'

    post:
      summary: Create template
      tags:
        - Templates
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LaTeXTemplate'
      responses:
        '201':
          description: Template created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LaTeXTemplate'

  /latex/templates/{templateId}:
    get:
      summary: Get template
      tags:
        - Templates
      parameters:
        - name: templateId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Template details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LaTeXTemplate'

    delete:
      summary: Delete template
      tags:
        - Templates
      parameters:
        - name: templateId
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Template deleted

  /latex/templates/{templateId}/clone:
    post:
      summary: Clone template to project
      tags:
        - Templates
      parameters:
        - name: templateId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                userId:
                  type: string
                projectName:
                  type: string
                variables:
                  type: object
                  additionalProperties:
                    type: string
      responses:
        '201':
          description: Project created from template
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LaTeXProject'

components:
  schemas:
    CompileCommand:
      type: object
      required:
        - jobId
        - userId
        - content
      properties:
        jobId:
          type: string
          description: Unique job identifier
        userId:
          type: string
          description: User ID for access control
        content:
          type: string
          description: LaTeX document content
        settings:
          type: object
          properties:
            engine:
              type: string
              enum: [xelatex, lualatex]
              default: xelatex
            maxPasses:
              type: integer
              minimum: 1
              maximum: 5
              default: 3
            timeout:
              type: integer
              description: Compilation timeout in milliseconds
              default: 60000
            shell:
              type: boolean
              description: Enable shell escape for external commands
              default: false

    CompilationResult:
      type: object
      required:
        - success
        - compilationTime
        - passes
        - errors
        - warnings
        - logs
      properties:
        success:
          type: boolean
        pdfPath:
          type: string
          description: Path to generated PDF
        pdfId:
          type: string
          description: GridFS ID for PDF storage
        compilationTime:
          type: number
          description: Compilation time in milliseconds
        passes:
          type: integer
          description: Number of compilation passes executed
        errors:
          type: array
          items:
            $ref: '#/components/schemas/CompilationError'
        warnings:
          type: array
          items:
            $ref: '#/components/schemas/CompilationWarning'
        logs:
          $ref: '#/components/schemas/CompilationLogs'

    CompilationError:
      type: object
      properties:
        line:
          type: integer
          description: Line number in source document
        column:
          type: integer
          description: Column number
        message:
          type: string
          description: Error message
        severity:
          type: string
          enum: [error, warning, info]
        file:
          type: string
          description: File path (for multi-file projects)

    CompilationWarning:
      type: object
      properties:
        line:
          type: integer
        message:
          type: string
        file:
          type: string

    CompilationLogs:
      type: object
      properties:
        stdout:
          type: string
          description: Standard output
        stderr:
          type: string
          description: Standard error output
        rawLog:
          type: string
          description: Raw LaTeX compilation log

    CompilationJob:
      type: object
      properties:
        jobId:
          type: string
        documentId:
          type: string
        userId:
          type: string
        status:
          type: string
          enum: [pending, compiling, completed, failed, timeout, cancelled]
        result:
          $ref: '#/components/schemas/CompilationResult'
        createdAt:
          type: string
          format: date-time
        startedAt:
          type: string
          format: date-time
        completedAt:
          type: string
          format: date-time

    LaTeXProject:
      type: object
      properties:
        projectId:
          type: string
        userId:
          type: string
        name:
          type: string
        mainFile:
          type: string
          description: Main .tex file
        files:
          type: array
          items:
            type: object
            properties:
              filename:
                type: string
              content:
                type: string
              lastModified:
                type: string
                format: date-time
        dependencies:
          type: array
          items:
            type: string
          description: List of dependent files
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    LaTeXTemplate:
      type: object
      properties:
        templateId:
          type: string
        name:
          type: string
        category:
          type: string
          enum: [resume, academic, business, article, book, presentation]
        content:
          type: string
          description: Template LaTeX content
        variables:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              description:
                type: string
              placeholder:
                type: string
        isPublic:
          type: boolean
        createdBy:
          type: string
        createdAt:
          type: string
          format: date-time

    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
            details:
              type: object
        timestamp:
          type: string
          format: date-time
