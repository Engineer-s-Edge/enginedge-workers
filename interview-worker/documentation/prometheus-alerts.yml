groups:
  - name: interview-worker.alerts
    rules:
      # Service Health Alerts
      - alert: InterviewWorkerDown
        expr: up{job="interview-worker"} == 0
        for: 5m
        labels:
          severity: critical
          service: interview-worker
        annotations:
          summary: "Interview Worker is down"
          description: "Interview Worker has been down for more than 5 minutes."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/interview-worker/documentation/TROUBLESHOOTING.md#service-down"

      - alert: InterviewWorkerHighErrorRate
        expr: rate(http_requests_total{job="interview-worker", status=~"5.."}[5m]) / rate(http_requests_total{job="interview-worker"}[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
          service: interview-worker
        annotations:
          summary: "High error rate in Interview Worker"
          description: "Interview Worker error rate is {{ $value | printf \"%.2f\" }}% over the last 5 minutes."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/interview-worker/documentation/TROUBLESHOOTING.md#high-error-rate"

      - alert: InterviewWorkerCriticalErrorRate
        expr: rate(http_requests_total{job="interview-worker", status=~"5.."}[5m]) / rate(http_requests_total{job="interview-worker"}[5m]) > 0.1
        for: 3m
        labels:
          severity: critical
          service: interview-worker
        annotations:
          summary: "Critical error rate in Interview Worker"
          description: "Interview Worker error rate is {{ $value | printf \"%.2f\" }}% over the last 3 minutes."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/interview-worker/documentation/TROUBLESHOOTING.md#high-error-rate"

      # Performance Alerts
      - alert: InterviewWorkerHighLatency
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job="interview-worker"}[5m])) > 5
        for: 5m
        labels:
          severity: warning
          service: interview-worker
        annotations:
          summary: "High latency in Interview Worker"
          description: "Interview Worker P95 response time is {{ $value | printf \"%.2f\" }}s over the last 5 minutes."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/interview-worker/documentation/PERFORMANCE.md#latency-optimization"

      - alert: InterviewWorkerCriticalLatency
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket{job="interview-worker"}[5m])) > 10
        for: 3m
        labels:
          severity: critical
          service: interview-worker
        annotations:
          summary: "Critical latency in Interview Worker"
          description: "Interview Worker P95 response time is {{ $value | printf \"%.2f\" }}s over the last 3 minutes."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/interview-worker/documentation/PERFORMANCE.md#latency-optimization"

      # Session Management Alerts
      - alert: InterviewWorkerHighSessionFailureRate
        expr: rate(interview_sessions_completed_total{status="failed",job="interview-worker"}[5m]) / rate(interview_sessions_completed_total{job="interview-worker"}[5m]) > 0.1
        for: 5m
        labels:
          severity: critical
          service: interview-worker
        annotations:
          summary: "High session completion failure rate"
          description: "Session completion failure rate is {{ $value | printf \"%.2f\" }}% over the last 5 minutes."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/interview-worker/documentation/TROUBLESHOOTING.md#session-failures"

      - alert: InterviewWorkerLowSessionCompletionRate
        expr: rate(interview_sessions_completed_total{job="interview-worker"}[5m]) / rate(interview_sessions_created_total{job="interview-worker"}[5m]) < 0.5
        for: 10m
        labels:
          severity: warning
          service: interview-worker
        annotations:
          summary: "Low session completion rate"
          description: "Only {{ $value | printf \"%.2f\" }}% of sessions are being completed."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/interview-worker/documentation/MONITORING.md#session-metrics"

      # WebSocket Alerts
      - alert: InterviewWorkerWebSocketConnectionFailure
        expr: rate(websocket_connections_total{status="failed",job="interview-worker"}[5m]) / rate(websocket_connections_total{job="interview-worker"}[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
          service: interview-worker
        annotations:
          summary: "High WebSocket connection failure rate"
          description: "WebSocket connection failure rate is {{ $value | printf \"%.2f\" }}% over the last 5 minutes."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/interview-worker/documentation/TROUBLESHOOTING.md#websocket-issues"

      - alert: InterviewWorkerWebSocketHighDisconnectRate
        expr: rate(websocket_disconnections_total{job="interview-worker"}[5m]) > rate(websocket_connections_total{job="interview-worker"}[5m]) * 0.2
        for: 5m
        labels:
          severity: warning
          service: interview-worker
        annotations:
          summary: "High WebSocket disconnect rate"
          description: "WebSocket disconnect rate is abnormally high compared to connection rate."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/interview-worker/documentation/TROUBLESHOOTING.md#websocket-issues"

      # Database Alerts
      - alert: InterviewWorkerMongoDBConnectionIssues
        expr: mongodb_connection_errors_total{job="interview-worker"} > 10
        for: 5m
        labels:
          severity: critical
          service: interview-worker
        annotations:
          summary: "MongoDB connection errors"
          description: "MongoDB has {{ $value }} connection errors."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/interview-worker/documentation/TROUBLESHOOTING.md#database-issues"

      - alert: InterviewWorkerMongoDBHighLatency
        expr: histogram_quantile(0.95, rate(mongodb_operation_duration_seconds_bucket{job="interview-worker"}[5m])) > 1
        for: 5m
        labels:
          severity: warning
          service: interview-worker
        annotations:
          summary: "High MongoDB operation latency"
          description: "MongoDB P95 operation duration is {{ $value | printf \"%.2f\" }}s over the last 5 minutes."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/interview-worker/documentation/PERFORMANCE.md#database-optimization"

      # Report Generation Alerts
      - alert: InterviewWorkerReportGenerationFailure
        expr: rate(interview_reports_generated_total{status="failed",job="interview-worker"}[5m]) / rate(interview_reports_generated_total{job="interview-worker"}[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
          service: interview-worker
        annotations:
          summary: "High report generation failure rate"
          description: "Report generation failure rate is {{ $value | printf \"%.2f\" }}% over the last 5 minutes."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/interview-worker/documentation/TROUBLESHOOTING.md#report-generation"

      - alert: InterviewWorkerReportGenerationSlow
        expr: histogram_quantile(0.95, rate(interview_report_generation_duration_seconds_bucket{job="interview-worker"}[5m])) > 30
        for: 5m
        labels:
          severity: warning
          service: interview-worker
        annotations:
          summary: "Slow report generation"
          description: "Report generation P95 duration is {{ $value | printf \"%.2f\" }}s over the last 5 minutes."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/interview-worker/documentation/PERFORMANCE.md#report-generation"

      # Resource Alerts
      - alert: InterviewWorkerHighCPUUsage
        expr: rate(process_cpu_user_seconds_total{job="interview-worker"}[5m]) * 100 > 80
        for: 10m
        labels:
          severity: warning
          service: interview-worker
        annotations:
          summary: "High CPU usage in Interview Worker"
          description: "Interview Worker CPU usage is {{ $value | printf \"%.2f\" }}% over the last 10 minutes."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/interview-worker/documentation/PERFORMANCE.md#resource-optimization"

      - alert: InterviewWorkerCriticalCPUUsage
        expr: rate(process_cpu_user_seconds_total{job="interview-worker"}[5m]) * 100 > 95
        for: 5m
        labels:
          severity: critical
          service: interview-worker
        annotations:
          summary: "Critical CPU usage in Interview Worker"
          description: "Interview Worker CPU usage is {{ $value | printf \"%.2f\" }}% over the last 5 minutes."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/interview-worker/documentation/PERFORMANCE.md#resource-optimization"

      - alert: InterviewWorkerHighMemoryUsage
        expr: process_resident_memory_bytes{job="interview-worker"} / 1024 / 1024 > 1024
        for: 10m
        labels:
          severity: warning
          service: interview-worker
        annotations:
          summary: "High memory usage in Interview Worker"
          description: "Interview Worker memory usage is {{ $value | printf \"%.2f\" }}MB over the last 10 minutes."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/interview-worker/documentation/PERFORMANCE.md#memory-management"

      - alert: InterviewWorkerCriticalMemoryUsage
        expr: process_resident_memory_bytes{job="interview-worker"} / 1024 / 1024 > 1536
        for: 5m
        labels:
          severity: critical
          service: interview-worker
        annotations:
          summary: "Critical memory usage in Interview Worker"
          description: "Interview Worker memory usage is {{ $value | printf \"%.2f\" }}MB over the last 5 minutes."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/interview-worker/documentation/PERFORMANCE.md#memory-management"

      # Business Logic Alerts
      - alert: InterviewWorkerNoActiveSessions
        expr: interview_sessions_active{job="interview-worker"} == 0
        for: 30m
        labels:
          severity: info
          service: interview-worker
        annotations:
          summary: "No active interview sessions"
          description: "No active interview sessions detected for the last 30 minutes. This may indicate a processing issue or low usage period."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/interview-worker/documentation/MONITORING.md#business-metrics"

      - alert: InterviewWorkerHighQuestionSkipRate
        expr: rate(interview_questions_skipped_total{job="interview-worker"}[5m]) / rate(interview_questions_selected_total{job="interview-worker"}[5m]) > 0.2
        for: 10m
        labels:
          severity: warning
          service: interview-worker
        annotations:
          summary: "High question skip rate"
          description: "Question skip rate is {{ $value | printf \"%.2f\" }}% of selected questions."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/interview-worker/documentation/MONITORING.md#question-metrics"
