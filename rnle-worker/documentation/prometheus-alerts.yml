groups:
  - name: rnle-worker.alerts
    rules:
      # Service Health Alerts
      - alert: RNLEWorkerDown
        expr: up{job="rnle-worker"} == 0
        for: 5m
        labels:
          severity: critical
          service: rnle-worker
        annotations:
          summary: "RNLE Worker is down"
          description: "RNLE Worker has been down for more than 5 minutes."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/rnle-worker/documentation/TROUBLESHOOTING.md#service-completely-down"

      - alert: RNLEWorkerHighErrorRate
        expr: rate(command_processing_total{status="failed", job="rnle-worker"}[5m]) / rate(command_processing_total{job="rnle-worker"}[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
          service: rnle-worker
        annotations:
          summary: "High command failure rate in RNLE Worker"
          description: "Command failure rate is {{ $value | printf \"%.2f\" }}% over the last 5 minutes."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/rnle-worker/documentation/TROUBLESHOOTING.md#high-error-rate"

      # Performance Alerts
      - alert: RNLEWorkerHighLatency
        expr: histogram_quantile(0.95, rate(command_processing_duration_seconds_bucket{job="rnle-worker"}[5m])) > 5
        for: 5m
        labels:
          severity: warning
          service: rnle-worker
        annotations:
          summary: "High processing latency in RNLE Worker"
          description: "P95 processing latency is {{ $value | printf \"%.2f\" }}s over the last 5 minutes."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/rnle-worker/documentation/PERFORMANCE.md#high-latency"

      - alert: RNLEWorkerHighQueueDepth
        expr: command_queue_depth{job="rnle-worker"} > 100
        for: 5m
        labels:
          severity: warning
          service: rnle-worker
        annotations:
          summary: "High queue depth in RNLE Worker"
          description: "Command queue depth is {{ $value }} over the last 5 minutes."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/rnle-worker/documentation/PERFORMANCE.md#high-queue-depth"

      - alert: RNLEWorkerHighHttpErrorRate
        expr: rate(http_requests_total{status=~"5..", job="rnle-worker"}[5m]) / rate(http_requests_total{job="rnle-worker"}[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
          service: rnle-worker
        annotations:
          summary: "High HTTP error rate in RNLE Worker"
          description: "HTTP error rate is {{ $value | printf \"%.2f\" }}% over the last 5 minutes."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/rnle-worker/documentation/TROUBLESHOOTING.md#high-error-rate"

      # Resource Alerts
      - alert: RNLEWorkerHighCPUUsage
        expr: rate(process_cpu_user_seconds_total{job="rnle-worker"}[5m]) * 100 > 80
        for: 10m
        labels:
          severity: warning
          service: rnle-worker
        annotations:
          summary: "High CPU usage in RNLE Worker"
          description: "CPU usage is {{ $value | printf \"%.2f\" }}% over the last 10 minutes."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/rnle-worker/documentation/PERFORMANCE.md#resource-optimization"

      - alert: RNLEWorkerHighMemoryUsage
        expr: process_resident_memory_bytes{job="rnle-worker"} / 1024 / 1024 > 400
        for: 10m
        labels:
          severity: warning
          service: rnle-worker
        annotations:
          summary: "High memory usage in RNLE Worker"
          description: "Memory usage is {{ $value | printf \"%.0f\" }}MB over the last 10 minutes."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/rnle-worker/documentation/TROUBLESHOOTING.md#memory-usage-high"

      - alert: RNLEWorkerHighEventLoopLag
        expr: nodejs_eventloop_lag_seconds{job="rnle-worker"} > 1
        for: 5m
        labels:
          severity: warning
          service: rnle-worker
        annotations:
          summary: "High event loop lag in RNLE Worker"
          description: "Event loop lag is {{ $value | printf \"%.2f\" }}s over the last 5 minutes."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/rnle-worker/documentation/PERFORMANCE.md#event-loop-optimization"

      # Kafka Integration Alerts
      - alert: RNLEWorkerKafkaConsumerLag
        expr: kafka_consumer_group_lag{group="rnle-worker-commands", job="rnle-worker"} > 1000
        for: 5m
        labels:
          severity: warning
          service: rnle-worker
        annotations:
          summary: "High Kafka consumer lag in RNLE Worker"
          description: "Kafka consumer lag is {{ $value }} messages."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/rnle-worker/documentation/KAFKA_TOPICS.md#consumer-lag"

      - alert: RNLEWorkerKafkaProducerErrors
        expr: rate(kafka_producer_errors_total{job="rnle-worker"}[5m]) > 0
        for: 5m
        labels:
          severity: warning
          service: rnle-worker
        annotations:
          summary: "Kafka producer errors in RNLE Worker"
          description: "Kafka producer errors detected: {{ $value }} errors per second."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/rnle-worker/documentation/KAFKA_TOPICS.md#producer-errors"

      # Database Alerts
      - alert: RNLEWorkerDatabaseConnectionPoolExhausted
        expr: mongodb_connections_active{job="rnle-worker"} / mongodb_connections_available{job="rnle-worker"} > 0.9
        for: 5m
        labels:
          severity: warning
          service: rnle-worker
        annotations:
          summary: "Database connection pool nearly exhausted"
          description: "Database connection pool usage is {{ $value | printf \"%.1f\" }}%."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/rnle-worker/documentation/TROUBLESHOOTING.md#database-connection-issues"

      - alert: RNLEWorkerDatabaseSlowQueries
        expr: histogram_quantile(0.95, rate(mongodb_query_duration_seconds_bucket{job="rnle-worker"}[5m])) > 2
        for: 5m
        labels:
          severity: warning
          service: rnle-worker
        annotations:
          summary: "Slow database queries in RNLE Worker"
          description: "P95 query duration is {{ $value | printf \"%.2f\" }}s over the last 5 minutes."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/rnle-worker/documentation/PERFORMANCE.md#database-optimization"

      # Business Logic Alerts
      - alert: RNLEWorkerNoCommandProcessing
        expr: rate(command_processing_total{job="rnle-worker"}[15m]) == 0
        for: 30m
        labels:
          severity: info
          service: rnle-worker
        annotations:
          summary: "No command processing activity"
          description: "No commands have been processed for the last 30 minutes."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/rnle-worker/documentation/MONITORING.md#business-metrics"

      - alert: RNLEWorkerHighAssistantCommandFailure
        expr: rate(command_processing_total{task_type="EXECUTE_ASSISTANT", status="failed", job="rnle-worker"}[5m]) / rate(command_processing_total{task_type="EXECUTE_ASSISTANT", job="rnle-worker"}[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          service: rnle-worker
        annotations:
          summary: "High assistant command failure rate"
          description: "Assistant command failure rate is {{ $value | printf \"%.2f\" }}% over the last 5 minutes."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/rnle-worker/documentation/TROUBLESHOOTING.md#assistant-command-failures"

      - alert: RNLEWorkerHighHabitsCommandFailure
        expr: rate(command_processing_total{task_type="SCHEDULE_HABITS", status="failed", job="rnle-worker"}[5m]) / rate(command_processing_total{task_type="SCHEDULE_HABITS", job="rnle-worker"}[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          service: rnle-worker
        annotations:
          summary: "High habits command failure rate"
          description: "Habits command failure rate is {{ $value | printf \"%.2f\" }}% over the last 5 minutes."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/rnle-worker/documentation/TROUBLESHOOTING.md#habits-command-failures"

      # Health Check Alerts
      - alert: RNLEWorkerHealthCheckFailing
        expr: probe_success{job="rnle-worker-health"} == 0
        for: 3m
        labels:
          severity: critical
          service: rnle-worker
        annotations:
          summary: "Health check failing for RNLE Worker"
          description: "Health check has been failing for the last 3 minutes."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/rnle-worker/documentation/TROUBLESHOOTING.md#health-check-failures"

      - alert: RNLEWorkerDependencyHealthDegraded
        expr: probe_success{job="rnle-worker-kafka-health"} == 0 OR probe_success{job="rnle-worker-db-health"} == 0
        for: 5m
        labels:
          severity: warning
          service: rnle-worker
        annotations:
          summary: "Dependency health degraded"
          description: "One or more dependencies (Kafka/Database) are unhealthy."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/rnle-worker/documentation/TROUBLESHOOTING.md#dependency-health-issues"

      # Garbage Collection Alerts
      - alert: RNLEWorkerHighGCActivity
        expr: rate(nodejs_gc_duration_seconds_total{job="rnle-worker"}[5m]) > 0.1
        for: 10m
        labels:
          severity: info
          service: rnle-worker
        annotations:
          summary: "High garbage collection activity"
          description: "GC duration is {{ $value | printf \"%.2f\" }}s per second over the last 10 minutes."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/rnle-worker/documentation/PERFORMANCE.md#memory-management"

      - alert: RNLEWorkerHighHeapUsage
        expr: nodejs_heap_size_used_bytes{job="rnle-worker"} / nodejs_heap_size_total_bytes{job="rnle-worker"} > 0.85
        for: 10m
        labels:
          severity: warning
          service: rnle-worker
        annotations:
          summary: "High heap usage in RNLE Worker"
          description: "Heap usage is {{ $value | printf \"%.1f\" }}% over the last 10 minutes."
          runbook_url: "https://github.com/enginedge/enginedge-workers/blob/main/rnle-worker/documentation/TROUBLESHOOTING.md#memory-usage-high"