openapi: 3.0.3
info:
  title: RNLE Worker API
  description: |
    The RNLE (Resume Natural Language Engine) Worker provides RESTful APIs for processing background commands
    related to assistant operations and habit scheduling. Built with NestJS and following hexagonal architecture
    principles, this service handles asynchronous command processing with high reliability and scalability.
  version: 1.0.0
  contact:
    name: EnginEdge Team
    email: team@enginedge.com
  license:
    name: Proprietary
    url: https://enginedge.com/license

servers:
  - url: http://localhost:3001
    description: Local development server
  - url: https://api.enginedge.com/rnle-worker
    description: Production server

security:
  - ApiKeyAuth: []

paths:
  /health:
    get:
      summary: Health check endpoint
      description: Returns the health status of the service and its dependencies
      operationId: getHealth
      tags:
        - Health
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: "ok"
                timestamp: "2024-01-15T10:30:00.000Z"
                uptime: 3600
                version: "1.0.0"
                checks:
                  kafka:
                    status: "up"
                    responseTime: 45
                  database:
                    status: "up"
                    responseTime: 23
        '503':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: "error"
                timestamp: "2024-01-15T10:30:00.000Z"
                checks:
                  kafka:
                    status: "down"
                    error: "Connection timeout"

  /health/detailed:
    get:
      summary: Detailed health check
      description: Returns detailed health status including dependency checks
      operationId: getDetailedHealth
      tags:
        - Health
      responses:
        '200':
          description: Detailed health information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DetailedHealthResponse'
        '503':
          description: Service or dependencies are unhealthy

  /command/process:
    post:
      summary: Process a command
      description: |
        Processes a background command asynchronously. The command is queued for processing
        and results are published to Kafka topics for consumption by other services.
      operationId: processCommand
      tags:
        - Commands
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CommandRequest'
            examples:
              execute-assistant:
                summary: Execute assistant command
                value:
                  taskId: "assist-001"
                  taskType: "EXECUTE_ASSISTANT"
                  payload:
                    assistantId: "asst_123"
                    userId: "user_456"
                    input: "Analyze this resume for software engineering roles"
                    metadata:
                      priority: "high"
                      timeout: 300
              schedule-habits:
                summary: Schedule habits command
                value:
                  taskId: "habit-001"
                  taskType: "SCHEDULE_HABITS"
                  payload:
                    userId: "user_456"
                    habits:
                      - name: "Morning Exercise"
                        frequency: "daily"
                        time: "07:00"
                        duration: 30
      responses:
        '200':
          description: Command accepted for processing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CommandResponse'
              examples:
                success:
                  summary: Command processing started
                  value:
                    taskId: "assist-001"
                    status: "SUCCESS"
                    result:
                      message: "Command accepted for processing"
                      estimatedCompletion: "2024-01-15T10:31:00.000Z"
        '400':
          description: Invalid request data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalid-task-type:
                  summary: Invalid task type
                  value:
                    taskId: "invalid-001"
                    status: "FAILURE"
                    error:
                      code: "VALIDATION_ERROR"
                      message: "Invalid taskType. Must be EXECUTE_ASSISTANT or SCHEDULE_HABITS"
                missing-fields:
                  summary: Missing required fields
                  value:
                    status: "FAILURE"
                    error:
                      code: "VALIDATION_ERROR"
                      message: "Missing required fields: taskId, taskType"
        '429':
          description: Too many requests
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                processing-error:
                  summary: Command processing failed
                  value:
                    taskId: "assist-001"
                    status: "FAILURE"
                    error:
                      code: "PROCESSING_ERROR"
                      message: "Failed to queue command for processing"

  /metrics:
    get:
      summary: Prometheus metrics
      description: Returns Prometheus-compatible metrics for monitoring
      operationId: getMetrics
      tags:
        - Monitoring
      responses:
        '200':
          description: Metrics data
          content:
            text/plain:
              schema:
                type: string
                example: |
                  # HELP http_requests_total Total number of HTTP requests
                  # TYPE http_requests_total counter
                  http_requests_total{method="POST",route="/command/process",status="200"} 150

                  # HELP command_processing_duration_seconds Time spent processing commands
                  # TYPE command_processing_duration_seconds histogram
                  command_processing_duration_seconds_bucket{le="0.1"} 5
                  command_processing_duration_seconds_bucket{le="0.5"} 12

components:
  schemas:
    CommandRequest:
      type: object
      required:
        - taskId
        - taskType
      properties:
        taskId:
          type: string
          description: Unique identifier for the command task
          example: "assist-001"
          pattern: "^[a-zA-Z0-9_-]+$"
          minLength: 1
          maxLength: 100
        taskType:
          type: string
          enum: [EXECUTE_ASSISTANT, SCHEDULE_HABITS]
          description: Type of command to execute
          example: "EXECUTE_ASSISTANT"
        payload:
          type: object
          description: Command-specific payload data
          properties:
            assistantId:
              type: string
              description: Assistant identifier (for EXECUTE_ASSISTANT)
              example: "asst_123"
            userId:
              type: string
              description: User identifier
              example: "user_456"
            input:
              type: string
              description: Input data for processing
              example: "Analyze this resume"
            habits:
              type: array
              description: Habit definitions (for SCHEDULE_HABITS)
              items:
                type: object
                properties:
                  name:
                    type: string
                    example: "Morning Exercise"
                  frequency:
                    type: string
                    enum: [daily, weekly, monthly]
                    example: "daily"
                  time:
                    type: string
                    pattern: "^([01]?[0-9]|2[0-3]):[0-5][0-9]$"
                    example: "07:00"
                  duration:
                    type: integer
                    minimum: 1
                    maximum: 1440
                    example: 30
            metadata:
              type: object
              description: Additional metadata
              properties:
                priority:
                  type: string
                  enum: [low, normal, high, urgent]
                  example: "high"
                timeout:
                  type: integer
                  minimum: 30
                  maximum: 3600
                  description: Timeout in seconds
                  example: 300

    CommandResponse:
      type: object
      required:
        - taskId
        - status
      properties:
        taskId:
          type: string
          description: Original command task identifier
          example: "assist-001"
        status:
          type: string
          enum: [SUCCESS, FAILURE]
          description: Processing outcome status
          example: "SUCCESS"
        result:
          type: object
          description: Processing result data (when status is SUCCESS)
          properties:
            message:
              type: string
              description: Success message
              example: "Command accepted for processing"
            estimatedCompletion:
              type: string
              format: date-time
              description: Estimated completion timestamp
              example: "2024-01-15T10:31:00.000Z"
            queuePosition:
              type: integer
              description: Position in processing queue
              example: 3
        error:
          $ref: '#/components/schemas/ErrorDetails'

    ErrorResponse:
      type: object
      required:
        - status
        - error
      properties:
        taskId:
          type: string
          description: Task identifier (if available)
          example: "assist-001"
        status:
          type: string
          enum: [FAILURE]
          description: Error status
          example: "FAILURE"
        error:
          $ref: '#/components/schemas/ErrorDetails'

    ErrorDetails:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          description: Error code for programmatic handling
          enum:
            - VALIDATION_ERROR
            - PROCESSING_ERROR
            - TIMEOUT_ERROR
            - RESOURCE_ERROR
            - EXTERNAL_SERVICE_ERROR
          example: "VALIDATION_ERROR"
        message:
          type: string
          description: Human-readable error message
          example: "Invalid taskType. Must be EXECUTE_ASSISTANT or SCHEDULE_HABITS"
        details:
          type: object
          description: Additional error context
          properties:
            field:
              type: string
              description: Field that caused the error
              example: "taskType"
            reason:
              type: string
              description: Detailed reason for the error
              example: "Value must be one of: EXECUTE_ASSISTANT, SCHEDULE_HABITS"
            retryable:
              type: boolean
              description: Whether the operation can be retried
              example: false

    HealthResponse:
      type: object
      required:
        - status
        - timestamp
      properties:
        status:
          type: string
          enum: [ok, error, degraded]
          description: Overall health status
          example: "ok"
        timestamp:
          type: string
          format: date-time
          description: Health check timestamp
          example: "2024-01-15T10:30:00.000Z"
        uptime:
          type: integer
          description: Service uptime in seconds
          example: 3600
        version:
          type: string
          description: Service version
          example: "1.0.0"
        checks:
          type: object
          description: Dependency health checks
          properties:
            kafka:
              $ref: '#/components/schemas/DependencyHealth'
            database:
              $ref: '#/components/schemas/DependencyHealth'

    DetailedHealthResponse:
      allOf:
        - $ref: '#/components/schemas/HealthResponse'
        - type: object
          properties:
            checks:
              type: object
              properties:
                kafka:
                  allOf:
                    - $ref: '#/components/schemas/DependencyHealth'
                    - type: object
                      properties:
                        details:
                          type: object
                          properties:
                            brokers:
                              type: integer
                              example: 3
                            topics:
                              type: array
                              items:
                                type: string
                              example: ["rnle.commands", "rnle.command-results"]
                database:
                  allOf:
                    - $ref: '#/components/schemas/DependencyHealth'
                    - type: object
                      properties:
                        details:
                          type: object
                          properties:
                            connections:
                              type: object
                              properties:
                                active:
                                  type: integer
                                  example: 5
                                available:
                                  type: integer
                                  example: 20
                                total:
                                  type: integer
                                  example: 25
                memory:
                  type: object
                  properties:
                    status:
                      type: string
                      enum: [up, down, warning]
                      example: "up"
                    details:
                      type: object
                      properties:
                        used:
                          type: integer
                          description: Memory used in MB
                          example: 180
                        total:
                          type: integer
                          description: Total memory in MB
                          example: 512
                        percentage:
                          type: number
                          description: Memory usage percentage
                          example: 35.2

    DependencyHealth:
      type: object
      required:
        - status
      properties:
        status:
          type: string
          enum: [up, down, degraded]
          description: Dependency status
          example: "up"
        responseTime:
          type: integer
          description: Response time in milliseconds
          example: 45
        error:
          type: string
          description: Error message if status is not 'up'
          example: "Connection timeout"

  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: API key for service authentication

  examples:
    command-execute-assistant:
      summary: Execute assistant command example
      value:
        taskId: "assist-001"
        taskType: "EXECUTE_ASSISTANT"
        payload:
          assistantId: "asst_123"
          userId: "user_456"
          input: "Please analyze this resume for software engineering positions"
          metadata:
            priority: "high"
            timeout: 300

    command-schedule-habits:
      summary: Schedule habits command example
      value:
        taskId: "habit-001"
        taskType: "SCHEDULE_HABITS"
        payload:
          userId: "user_456"
          habits:
            - name: "Daily Exercise"
              frequency: "daily"
              time: "07:00"
              duration: 30
            - name: "Reading Time"
              frequency: "daily"
              time: "20:00"
              duration: 60

tags:
  - name: Commands
    description: Command processing operations
  - name: Health
    description: Service health monitoring
  - name: Monitoring
    description: Metrics and monitoring endpoints

externalDocs:
  description: Complete documentation
  url: https://github.com/enginedge/enginedge-workers/tree/main/rnle-worker/documentation