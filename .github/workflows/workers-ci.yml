name: workers-ci

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
  push:
    tags:
      - 'v*.*.*'
      - '*-worker-v*.*.*'

jobs:
  changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      workers-matrix: ${{ steps.set-matrix.outputs.matrix }}
      python-changed: ${{ steps.set-matrix.outputs.python_changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          filters: |
            assistant-worker:
              - 'assistant-worker/**'
            agent-tool-worker:
              - 'agent-tool-worker/**'
            data-processing-worker:
              - 'data-processing-worker/**'
            interview-worker:
              - 'interview-worker/**'
            latex-worker:
              - 'latex-worker/**'
            resume-worker:
              - 'resume-worker/**'
            identity-worker:
              - 'identity-worker/**'
            scheduling-worker:
              - 'scheduling-worker/**'
            spacy-service:
              - 'spacy-service/**'
      - name: Build matrix JSON
        id: set-matrix
        run: |
          # map worker to port
          declare -A ports=( \
            [assistant-worker]=3001 \
            [agent-tool-worker]=3002 \
            [data-processing-worker]=3003 \
            [interview-worker]=3004 \
            [latex-worker]=3005 \
            [resume-worker]=3006 \
            [identity-worker]=3000 \
            [scheduling-worker]=3000 )
          list=()
          for w in "assistant-worker" "agent-tool-worker" "data-processing-worker" "interview-worker" "latex-worker" "resume-worker" "identity-worker" "scheduling-worker"; do
            changed=$(jq -r '."'"$w"'"' <<<'${{ toJson(steps.filter.outputs) }}')
            if [ "$changed" = "true" ]; then
              port=${ports[$w]}
              list+=("{\"worker\":\"$w\",\"port\":$port}")
            fi
          done
          matrix_json="{\"include\":[${list[*]}]}"
          echo "matrix=$matrix_json" >> $GITHUB_OUTPUT
          python_changed=$(jq -r '."spacy-service"' <<<'${{ toJson(steps.filter.outputs) }}')
          echo "python_changed=$python_changed" >> $GITHUB_OUTPUT

  node-workers:
    needs: changes
    runs-on: ubuntu-latest
    if: ${{ fromJson(needs.changes.outputs['workers-matrix']).include != null && fromJson(needs.changes.outputs['workers-matrix']).include[0] != null }}
    strategy:
      matrix: ${{ fromJson(needs.changes.outputs['workers-matrix']) }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install deps
        working-directory: ${{ matrix.worker }}
        run: npm ci || npm install
      - name: Format check
        working-directory: ${{ matrix.worker }}
        run: npm run format:check || (echo "Formatting check failed. Run 'npm run format' to fix." && exit 1)
      - name: Lint check
        working-directory: ${{ matrix.worker }}
        run: npm run lint:check || (echo "Linting check failed. Run 'npm run lint' to fix." && exit 1)
      - name: Test
        working-directory: ${{ matrix.worker }}
        continue-on-error: true
        run: npm test --if-present
      - name: Build
        working-directory: ${{ matrix.worker }}
        run: npm run build --if-present

  deploy-node-workers:
    needs: [changes, node-workers]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: read
      packages: write
    strategy:
      matrix: ${{ fromJson(needs.changes.outputs['workers-matrix']) }}
    steps:
      - uses: actions/checkout@v4
      - name: Docker login
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Extract tag name
        id: tag
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      - name: Docker build & push
        working-directory: ${{ matrix.worker }}
        run: |
          IMAGE_BASE=ghcr.io/${{ github.repository_owner }}/${{ matrix.worker }}
          docker build -t ${IMAGE_BASE}:${{ steps.tag.outputs.tag }} -t ${IMAGE_BASE}:latest .
          docker push ${IMAGE_BASE}:${{ steps.tag.outputs.tag }}
          docker push ${IMAGE_BASE}:latest

  python-services:
    needs: changes
    runs-on: ubuntu-latest
    if: ${{ needs.changes.outputs.python-changed == 'true' }}
    strategy:
      matrix:
        service: [spacy-service]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        working-directory: ${{ matrix.service }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install black isort flake8 || true
      - name: Format check
        working-directory: ${{ matrix.service }}
        run: |
          black --check . || (echo "Black formatting check failed. Run 'black .' to fix." && exit 1)
          isort --check-only --profile black . || (echo "isort check failed. Run 'isort . --profile black' to fix." && exit 1)
      - name: Lint check
        working-directory: ${{ matrix.service }}
        run: |
          flake8 . --max-line-length=100 --extend-ignore=E203,W503 || (echo "Flake8 check failed. Fix linting errors." && exit 1)
      - name: Test
        working-directory: ${{ matrix.service }}
        run: pytest -q || true

  deploy-python-services:
    needs: [changes, python-services]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        service: [spacy-service]
    steps:
      - uses: actions/checkout@v4
      - name: Docker login
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Extract tag name
        id: tag
        run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      - name: Docker build & push
        working-directory: ${{ matrix.service }}
        run: |
          IMAGE_BASE=ghcr.io/${{ github.repository_owner }}/${{ matrix.service }}
          docker build -t ${IMAGE_BASE}:${{ steps.tag.outputs.tag }} -t ${IMAGE_BASE}:latest .
          docker push ${IMAGE_BASE}:${{ steps.tag.outputs.tag }}
          docker push ${IMAGE_BASE}:latest
