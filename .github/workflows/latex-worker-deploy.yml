name: Deploy LaTeX Worker

on:
  push:
    tags:
      - 'latex-worker-v*'

jobs:
  build-and-deploy:
    runs-on: self-hosted
    env:
      SERVICE_NAME: latex-worker
      DOCKERFILE_PATH: ./latex-worker
      DEPLOYMENT_NAME: latex-worker
      CONTAINER_NAME: latex-worker
      GITHUB_USER: chris-alexander-pop

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: tag_version
        run: |
          TAG_NAME="${{ github.ref_name }}"
          VERSION="${TAG_NAME#latex-worker-v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

      - name: Log in to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ env.GITHUB_USER }}" --password-stdin

      - name: Build Docker image
        run: |
          docker build \
            -t ghcr.io/${{ env.GITHUB_USER }}/${{ env.SERVICE_NAME }}:${{ steps.tag_version.outputs.version }} \
            -t ghcr.io/${{ env.GITHUB_USER }}/${{ env.SERVICE_NAME }}:latest \
            ${{ env.DOCKERFILE_PATH }}

      - name: Push Docker image
        run: |
          docker push ghcr.io/${{ env.GITHUB_USER }}/${{ env.SERVICE_NAME }}:${{ steps.tag_version.outputs.version }}
          docker push ghcr.io/${{ env.GITHUB_USER }}/${{ env.SERVICE_NAME }}:latest

      - name: Clean up local images
        if: success()
        run: |
          docker rmi ghcr.io/${{ env.GITHUB_USER }}/${{ env.SERVICE_NAME }}:${{ steps.tag_version.outputs.version }} || true
          docker rmi ghcr.io/${{ env.GITHUB_USER }}/${{ env.SERVICE_NAME }}:latest || true
          docker builder prune -af || true

      - name: Rollout deployment
        run: |
          kubectl rollout restart deployment/${{ env.DEPLOYMENT_NAME }}
          kubectl rollout status deployment/${{ env.DEPLOYMENT_NAME }} --timeout=120s

      - name: Verify deployment
        run: |
          echo "Waiting for pods to be ready..."
          kubectl wait --for=condition=ready pod \
            -l app=enginedge,component=${{ env.SERVICE_NAME }} \
            --timeout=180s
